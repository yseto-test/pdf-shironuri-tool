<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF見開き変換ツール</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .drop-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col items-center py-10 px-4">
    <div class="max-w-2xl w-full bg-white rounded-2xl shadow-xl p-8">
        <h1 class="text-2xl font-bold text-slate-800 mb-2 text-center">PDF見開き変換ツール</h1>
        <p class="text-slate-500 text-center mb-8">2つのページを1つのワイドページに結合します。</p>

        <!-- 設定項目 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">綴じ方向</label>
                <select id="direction" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="ltr">左から右 (標準)</option>
                    <option value="rtl">右から左 (漫画・縦書き)</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">最初のページ</label>
                <select id="firstPageSingle" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="false">最初から見開きにする</option>
                    <option value="true">1ページ目を単独にする (表紙)</option>
                </select>
            </div>
        </div>

        <!-- アップロードエリア -->
        <div id="dropZone" class="drop-zone rounded-xl p-10 flex flex-col items-center justify-center cursor-pointer mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-slate-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <p class="text-slate-600 font-medium">クリックして選択、またはPDFをドロップ</p>
            <p class="text-slate-400 text-xs mt-2">※ブラウザ内で処理されます</p>
            <input type="file" id="fileInput" class="hidden" accept="application/pdf">
        </div>

        <!-- ステータス表示 -->
        <div id="status" class="hidden mb-6">
            <div class="flex items-center justify-between mb-2">
                <span id="statusText" class="text-sm font-medium text-slate-700">処理中...</span>
                <span id="percentText" class="text-sm font-bold text-blue-600">0%</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2.5">
                <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
        </div>

        <div id="resultArea" class="hidden flex justify-center">
            <button id="downloadBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-200 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                変換後のPDFを保存
            </button>
        </div>

        <div id="errorBox" class="hidden mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm">
        </div>
    </div>

    <script>
        const { PDFDocument } = PDFLib;
        
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('status');
        const progressBar = document.getElementById('progressBar');
        const percentText = document.getElementById('percentText');
        const statusText = document.getElementById('statusText');
        const resultArea = document.getElementById('resultArea');
        const downloadBtn = document.getElementById('downloadBtn');
        const errorBox = document.getElementById('errorBox');

        let generatedPdfBytes = null;
        let generatedFileName = "";

        // UI Event Listeners
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === "application/pdf") {
                processPdf(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                processPdf(e.target.files[0]);
            }
        });

        downloadBtn.addEventListener('click', () => {
            if (!generatedPdfBytes) return;
            const blob = new Blob([generatedPdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = generatedFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        async function processPdf(file) {
            // UIのリセット
            errorBox.classList.add('hidden');
            status.classList.remove('hidden');
            resultArea.classList.add('hidden');
            updateProgress(0, "PDFを読み込んでいます...");

            try {
                const arrayBuffer = await file.arrayBuffer();
                const srcDoc = await PDFDocument.load(arrayBuffer);
                const outDoc = await PDFDocument.create();
                
                const pageCount = srcDoc.getPageCount();
                
                const isRtl = document.getElementById('direction').value === 'rtl';
                const skipFirst = document.getElementById('firstPageSingle').value === 'true';

                let i = 0;

                // 1ページ目を単独にする場合
                if (skipFirst && pageCount > 0) {
                    const [firstPage] = await outDoc.copyPages(srcDoc, [0]);
                    outDoc.addPage(firstPage);
                    i = 1;
                }

                // 2ページずつ結合
                while (i < pageCount) {
                    updateProgress((i / pageCount) * 100, `ページ結合中 (${i + 1}/${pageCount})`);
                    
                    const hasNext = i + 1 < pageCount;
                    
                    if (!hasNext) {
                        // 最後の1ページが余った場合
                        const [lastPage] = await outDoc.copyPages(srcDoc, [i]);
                        outDoc.addPage(lastPage);
                        i++;
                    } else {
                        // 2ページ分を取得
                        const [pageA, pageB] = await outDoc.embedPages(await srcDoc.copyPages(srcDoc, [i, i + 1]));
                        
                        // サイズ計算
                        const widthA = pageA.width;
                        const heightA = pageA.height;
                        const widthB = pageB.width;
                        const heightB = pageB.height;
                        
                        const targetHeight = Math.max(heightA, heightB);
                        const targetWidth = widthA + widthB;
                        
                        const newPage = outDoc.addPage([targetWidth, targetHeight]);
                        
                        if (isRtl) {
                            newPage.drawPage(pageA, { x: widthB, y: 0 });
                            newPage.drawPage(pageB, { x: 0, y: 0 });
                        } else {
                            newPage.drawPage(pageA, { x: 0, y: 0 });
                            newPage.drawPage(pageB, { x: widthA, y: 0 });
                        }
                        
                        i += 2;
                    }
                }

                updateProgress(90, "PDFを生成しています...");
                generatedPdfBytes = await outDoc.save();
                
                // ファイル名の変更: extensionを除去して「（見開き）.pdf」を付与
                const originalName = file.name;
                const lastDotIndex = originalName.lastIndexOf('.');
                if (lastDotIndex !== -1) {
                    const nameWithoutExt = originalName.substring(0, lastDotIndex);
                    generatedFileName = `${nameWithoutExt}（見開き）.pdf`;
                } else {
                    generatedFileName = `${originalName}（見開き）.pdf`;
                }
                
                updateProgress(100, "完了しました！");
                resultArea.classList.remove('hidden');

            } catch (err) {
                console.error(err);
                errorBox.textContent = "エラーが発生しました: " + err.message;
                errorBox.classList.remove('hidden');
                status.classList.add('hidden');
            }
        }

        function updateProgress(percent, text) {
            progressBar.style.width = `${percent}%`;
            percentText.textContent = `${Math.round(percent)}%`;
            statusText.textContent = text;
        }
    </script>
</body>
</html>